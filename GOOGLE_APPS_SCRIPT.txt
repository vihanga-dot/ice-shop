function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    
    // Replace with your actual Google Sheet ID
    const sheetId = 'YOUR_SHEET_ID_HERE'; // You'll need to replace this
    const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
    
    if (action === 'saveOrder') {
      const order = params.order;
      
      // Add the order to the sheet
      sheet.appendRow([
        order.id,
        order.customerId,
        order.customerName,
        order.customerEmail,
        order.customerPhone,
        order.customerAddress || '',
        order.deliveryType,
        JSON.stringify(order.items), // Store items as JSON string
        order.total,
        order.orderDate,
        order.status
      ]);
      
      return ContentService
        .createTextOutput(JSON.stringify({ success: true, message: 'Order saved successfully' }))
        .setMimeType(ContentService.MimeType.JSON);
    } 
    else if (action === 'getAllOrders') {
      const data = sheet.getDataRange().getValues();
      
      // Skip the header row and process the data
      const orders = [];
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] !== '') { // Check if the row has data
          orders.push({
            id: data[i][0],
            customerId: data[i][1],
            customerName: data[i][2],
            customerEmail: data[i][3],
            customerPhone: data[i][4],
            customerAddress: data[i][5],
            deliveryType: data[i][6],
            items: JSON.parse(data[i][7] || '[]'), // Parse items from JSON string
            total: data[i][8],
            orderDate: data[i][9],
            status: data[i][10]
          });
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({ success: true, orders: orders }))
        .setMimeType(ContentService.MimeType.JSON);
    } 
    else if (action === 'getOrderById') {
      const orderId = params.orderId;
      const data = sheet.getDataRange().getValues();
      
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] == orderId) { // Use == for type coercion
          return ContentService
            .createTextOutput(JSON.stringify({ 
              success: true, 
              order: {
                id: data[i][0],
                customerId: data[i][1],
                customerName: data[i][2],
                customerEmail: data[i][3],
                customerPhone: data[i][4],
                customerAddress: data[i][5],
                deliveryType: data[i][6],
                items: JSON.parse(data[i][7] || '[]'),
                total: data[i][8],
                orderDate: data[i][9],
                status: data[i][10]
              }
            }))
            .setMimeType(ContentService.MimeType.JSON);
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({ success: false, error: 'Order not found' }))
        .setMimeType(ContentService.MimeType.JSON);
    } 
    else if (action === 'updateOrder') {
      const order = params.order;
      const data = sheet.getDataRange().getValues();
      
      // Find the row with the matching order ID
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] == order.id) {
          // Update the status column (column K, index 10)
          sheet.getRange(i + 1, 11).setValue(order.status);
          
          return ContentService
            .createTextOutput(JSON.stringify({ success: true, message: 'Order updated successfully' }))
            .setMimeType(ContentService.MimeType.JSON);
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({ success: false, error: 'Order not found' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: 'Invalid action' }))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: Function to set up headers in the Google Sheet
function setupHeaders() {
  const sheetId = 'YOUR_SHEET_ID_HERE'; // Replace with your sheet ID
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  
  // Set header row
  const headers = [
    'Order ID',
    'Customer ID', 
    'Customer Name',
    'Customer Email',
    'Customer Phone',
    'Customer Address',
    'Delivery Type',
    'Items',
    'Total',
    'Order Date',
    'Status'
  ];
  
  // Check if headers already exist
  const currentHeaders = sheet.getRange(1, 1, 1, headers.length).getValues()[0];
  const isEmpty = currentHeaders.every(cell => cell === '');
  
  if (isEmpty) {
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    console.log('Headers set successfully');
  } else {
    console.log('Headers already exist');
  }
}